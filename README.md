# HL7-Ninja Appsync API

## Indexes
#### Primary Key (composit):
* pk (partition)
* sk (sort)

#### lsi0 (composit):
* lsi0_sk (sort)
* projection: ALL_ATTRIBUTES

#### gsi0 (partition only):
* gsi0_pk
* projection: gsi0_pk, pk and status

## Schema

#### App

|<item type>| pk      |sk                  |lsi0_sk               |tenant  |name  |type       |metadata|source       |target       |app_id|auth_type   |account              |email    |gsi0_pk |iso          |default_region|billing_info|event_id|
|-----------|---------|--------------------|----------------------|--------|------|-----------|--------|-------------|-------------|------|------------|---------------------|---------|--------|-------------|--------------|------------|--------|
|Tenant     |<name>   |T~                  |                      |        |<name>|           |{}      |             |             |<uuid>|            |                     |         |        |             |<aws region>  |{}          |<uuid>  |
|User       |<tenant> |U~<email>           |                      |<tenant>|<name>|           |{}      |             |             |      |            |                     |<email>  |<email> |             |              |            |        |
|App        |<tenant> |A~<name>            |                      |<tenant>|<name>|$app_type  |{}      |             |             |      |$auth_type  |<aws account number> |         |        |<b64 string> |              |            |        |
|Node       |<tenant> |N~<name>            |                      |<tenant>|<name>|$node_type |{}      |<source node>|<target node>|      |            |                     |         |        |             |              |            |        |
|Edge       |<tenant> |E~<source>\|<target>|E~<target>\|<source>  |<tenant>|<name>|           |{}      |             |             |      |            |                     |         |        |             |              |            |        |

* $app_type = Hl7App | EdgeApp
* $node_type = Hl7InboundNode | Hl7OutboundNode | ExternalNode | CustomNode
* $auth_type = cognito | x_account

### Immutable attributes
Attempting to change these attributes on an existing item will cause a "Condition check failed" exception. Once an item is created the arguments for these attributes must match the original.
* account
* auth_type
* type
* tenant
* email
* name
* gsi0_pk
* sk (Tenants, Users, App, Node)
* password (Password is reset by a special mutation. See below)


### App Passwords
Passwords for apps cannot be modified directly. Passwords are actually stored as 10 *'s in the password attribute.
Calling "ResetAppPassword(name)" will reset the password via the stream to one generated by us. The password will be
returned in the StreamNotifications subscription message as part of a JSON string. Calling ResetAppPassword on any app
that is not of type=ExternalApp AND auth_type=cognito will result in an appsync error. Once the UI has discarded the message
that password can not be retreived as it is not actually stored anywhere.

### Response types
For any item that has a "type" field, the __typename for that object will match its name. A mutation that returns an Hl7InboundNode for example would be typed as:
```
mutation = """
  putNode($node: String) {
    PutNode(node: $node){
      ... on Hl7InboundNode { # Declare __typename as the "type" argument to the mutation
        name
      }
    }
  }
"""
```

For queries the type will be inferred by the "type" attribute in the response.

### Datasource name/source
* dynamodb: <hl7 ninja table>
* kms_key_datasource: appsync-kms-key-datasource (Lambda)
* edge_datasource: appsync-edge-datasource (Lambda)
